<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Asistente</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
<style>
    .chat-container {
        height: calc(100vh - 160px);
        overflow-y: auto;
    }
    .message {
        max-width: 80%;
        margin: 10px;
        padding: 10px 15px;
        border-radius: 15px;
        white-space: pre-wrap; /* Mantener saltos de l√≠nea */
    }
    .user-message {
        background-color: #e2e8f0;
        margin-left: auto;
    }
    .assistant-message {
        background-color: #4299e1;
        color: white;
        margin-right: auto;
    }
    ul {
        padding-left: 20px;
        margin: 5px 0;
    }
    li {
        list-style-type: disc;
    }
    code {
        background-color: rgba(255,255,255,0.2);
        padding: 2px 5px;
        border-radius: 4px;
        font-family: monospace;
    }
</style>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
    <div class="bg-white rounded-lg shadow-lg">
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4 rounded-t-lg flex items-center justify-between">
            <h1 class="text-xl font-bold"><span id="assistant-name"></span></h1>
            <div class="flex gap-2">
                <button id="reset-chat" class="bg-white text-blue-600 px-3 py-1 rounded hover:bg-gray-200 transition">
                    üîÑ
                </button>
                <button id="go-index" class="bg-white text-blue-600 px-3 py-1 rounded hover:bg-gray-200 transition">
                    üèöÔ∏è‚Äã
                </button>
            </div>
        </div>

        <!-- Chat Messages Container -->
        <div id="chat-container" class="chat-container p-4"></div>

        <!-- Input Form -->
        <div class="border-t p-4">
            <form id="chat-form" class="flex gap-2">
                <input 
                    type="text" 
                    id="user-input" 
                    class="flex-1 p-2 border rounded-lg focus:outline-none focus:border-blue-500"
                    placeholder="Escribe tu mensaje aqu√≠..."
                    required
                >
                <button 
                    type="submit" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200"
                >
                    Enviar
                </button>
            </form>
        </div>
    </div>
</div>

<script>
const API_BASE = "https://albertaapi.onrender.com"; // Cambiar al backend real

const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');
const chatContainer = document.getElementById('chat-container');

const assistantName = localStorage.getItem("assistant_name") || "Asistente";
const assistantId = localStorage.getItem("assistant_id");

if (!assistantId) {
    alert("No hay asistente activo. Ve a la p√°gina de inicio para crear uno.");
    window.location.href = "index.html";
}

document.getElementById("assistant-name").textContent = assistantName;

// Funci√≥n para obtener CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/**
 * Formatea el texto del asistente para:
 * - Saltos de l√≠nea
 * - Negritas Markdown (**texto**)
 * - Cursivas Markdown (*texto*)
 * - Listas con guion (- item)
 * - C√≥digo inline con `
 */
function formatMessage(message) {
    if (!message) return "";

    let html = message
        .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
        .replace(/\*(.*?)\*/g, "<i>$1</i>")
        .replace(/`([^`]+)`/g, "<code>$1</code>")
        .replace(/\n/g, "<br>");

    // Convertir listas simples (- item) en <ul><li>
    const listRegex = /(?:<br>)*- (.*?)(?=<br>|$)/g;
    if (listRegex.test(html)) {
        html = html.replace(listRegex, "<li>$1</li>");
        html = "<ul>" + html + "</ul>";
    }
    return html;
}

// Agregar mensajes al chat
function addMessage(message, type) {
    const div = document.createElement('div');
    div.className = `message ${type}-message`;
    div.innerHTML = formatMessage(message);
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Bot√≥n Reiniciar Chat
document.getElementById("reset-chat").addEventListener("click", async () => {
    if (!confirm("¬øQuieres reiniciar el chat? Se eliminar√° el historial actual.")) return;

    chatContainer.innerHTML = "";

    try {
        const response = await fetch(`${API_BASE}/api8/reset-thread/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrftoken // ‚úÖ Incluido CSRF
            }
        });

        const data = await response.json();
        if (response.ok) {
            alert(data.message || "Chat reiniciado correctamente.");
        } else {
            throw new Error(data.error || "Error al reiniciar el chat.");
        }
    } catch (err) {
        console.error(err);
        alert("Ha ocurrido un error al reiniciar el chat.");
    }
});

// Bot√≥n Volver al Inicio
document.getElementById("go-index").addEventListener("click", () => {
    if (confirm("¬øQuieres salir y eliminar el asistente actual?")) {
        localStorage.removeItem("assistant_name");
        localStorage.removeItem("assistant_id");
        window.location.href = "index.html";
    }
});

// Enviar mensaje
chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = userInput.value.trim();
    if (!msg) return;

    addMessage(msg, 'user');
    userInput.value = '';

    // ‚úÖ Mensaje de loading
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message assistant-message';
    loadingDiv.textContent = 'El asistente est√° pensando... ‚è≥';
    chatContainer.appendChild(loadingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    try {
        const response = await fetch(`${API_BASE}/api8/get-response/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: new URLSearchParams({
                message: msg,
                assistant_id: assistantId
            })
        });

        const data = await response.json();

        // Reemplazar mensaje de loading
        chatContainer.removeChild(loadingDiv);

        if (response.ok && data.message) {
            addMessage(data.message, 'assistant');
        } else {
            throw new Error(data.error || "No se recibi√≥ respuesta del asistente.");
        }
    } catch (err) {
        console.error(err);
        chatContainer.removeChild(loadingDiv);
        addMessage("Lo siento, ha ocurrido un error al procesar tu mensaje.", 'assistant');
    }
});

</script>
</body>
</html>
